//
// Module mopshub_lib.mopshub_top.struct
//
// Created:
//          by - dcs.dcs (chipdev2.physik.uni-wuppertal.de)
//          at - 15:21:28 03/03/22
//
// Generated by Mentor Graphics' HDL Designer(TM) 2019.4 (Build 4)
//

`resetall
`timescale 1ns/10ps
module mopshub_top #(
   // synopsys template
   parameter n_buses              = 5'b00111,
   parameter seialize_data_stream = 1'b1
)
( 
   // Port Declarations
   input   wire           clk, 
   input   wire           clk_80, 
   input   wire           endwait_all, 
   input   wire           miso_c, 
   input   wire           miso_m, 
   input   wire           osc_auto_trim_mopshub, 
   input   wire           rst, 
   input   wire           rx0, 
   input   wire           rx1, 
   input   wire           rx10, 
   input   wire           rx11, 
   input   wire           rx12, 
   input   wire           rx13, 
   input   wire           rx14, 
   input   wire           rx15, 
   input   wire           rx16, 
   input   wire           rx17, 
   input   wire           rx18, 
   input   wire           rx19, 
   input   wire           rx2, 
   input   wire           rx20, 
   input   wire           rx21, 
   input   wire           rx22, 
   input   wire           rx23, 
   input   wire           rx24, 
   input   wire           rx25, 
   input   wire           rx26, 
   input   wire           rx27, 
   input   wire           rx28, 
   input   wire           rx29, 
   input   wire           rx3, 
   input   wire           rx30, 
   input   wire           rx31, 
   input   wire           rx4, 
   input   wire           rx5, 
   input   wire           rx6, 
   input   wire           rx7, 
   input   wire           rx8, 
   input   wire           rx9, 
   input   wire           rx_din, 
   input   wire           rx_elink1bit, 
   input   wire    [1:0]  rx_elink2bit, 
   output  wire           cs_active_c, 
   output  wire           cs_active_m, 
   output  wire           irq_can_rec, 
   output  wire           irq_can_tra, 
   output  wire           irq_elink_rec, 
   output  wire           irq_elink_tra, 
   output  wire           mosi_c, 
   output  wire           mosi_m, 
   output  wire    [4:0]  power_bus_cnt, 
   output  wire           rst_bus, 
   output  wire           rx_data_rdy, 
   output  wire           rx_fifo_full, 
   output  wire           sck_c, 
   output  wire           sck_m, 
   output  wire           tx0, 
   output  wire           tx1, 
   output  wire           tx10, 
   output  wire           tx11, 
   output  wire           tx12, 
   output  wire           tx13, 
   output  wire           tx14, 
   output  wire           tx15, 
   output  wire           tx16, 
   output  wire           tx17, 
   output  wire           tx18, 
   output  wire           tx19, 
   output  wire           tx2, 
   output  wire           tx20, 
   output  wire           tx21, 
   output  wire           tx22, 
   output  wire           tx23, 
   output  wire           tx24, 
   output  wire           tx25, 
   output  wire           tx26, 
   output  wire           tx27, 
   output  wire           tx28, 
   output  wire           tx29, 
   output  wire           tx3, 
   output  wire           tx30, 
   output  wire           tx31, 
   output  wire           tx4, 
   output  wire           tx5, 
   output  wire           tx6, 
   output  wire           tx7, 
   output  wire           tx8, 
   output  wire           tx9, 
   output  wire           tx_data_rdy, 
   output  wire           tx_dout, 
   output  wire           tx_efifo_full, 
   output  wire           tx_elink1bit, 
   output  wire    [1:0]  tx_elink2bit
);


// Internal Declarations


// Local declarations

// Internal signal declarations
wire         abort                  = 1'b0;
wire  [4:0]  addr;                             // request to caninterface block
reg          bit_cnt                = 1'b0;
wire         buffer_en;
wire         buffer_spi_tra_en;
wire  [4:0]  can_rec_select;
wire  [4:0]  can_tra_select;
wire         clk_en                 = 1'b1;
wire         cnt_done               = 1'b0;
wire         cs_m;
wire         cs_p;
reg   [1:0]  data_2bit_in           = 2'b11;
wire  [1:0]  data_2bit_inb;
wire  [1:0]  data_2bit_out;                    //  @ 40MHz
wire  [31:0] data_rec_spi;
wire  [75:0] data_rec_uplink;
wire  [75:0] data_tra_downlink;
wire  [31:0] data_tra_spi;
wire         done_trim_osc;
reg          dout1bit_r             = 1'b1;
wire         end_cnt                = 1'b0;
wire         end_init;
wire         end_mon_init;
wire         end_osc_cnt;
wire         end_read_elink;
wire         end_read_miso;
wire         end_spi_proc;
wire         end_trim_bus;
wire         end_write_elink;
wire         end_write_elink_spi;
wire         endwait_all2           = 1'b0;    // Upon receiving a reset message on the CANbus. FSM goes into a known state
wire         entimeout;
wire         ext_counter_gen;
wire         irq_spi_tra;
wire         main_timeoutrst;
wire         power_bus_en;
wire         power_bus_en_done;
wire         read_spi_mode;
wire         rl                     = 1'b1;
wire         rst_osc_cnt;
wire         sign_on_sig;
wire         spi_cs;
wire         start_cnt;
wire         start_init;
wire         start_init_spi;
wire         start_mon_init;
wire         start_osc_cnt;
wire         start_read_elink;
wire         start_read_elink_can;
wire         start_read_elink_spi;
wire         start_read_miso;
wire         start_read_mon         = 1'b0;
wire         start_trim_ack;
wire         start_write_elink_spi;
wire         start_write_link;
wire  [6:0]  statedeb;                         // State debug signal 

// ModuleWare signal declarations(v1.12) for instance 'tx_shift' of 'shiftps'
reg [1:0] mw_tx_shiftreg_cval;
wire [1:0] mw_tx_shiftreg_nval;

// ModuleWare signal declarations(v1.12) for instance 'rx_shift' of 'shiftsp'
reg [1:0] mw_rx_shiftreg_cval;
wire [1:0] mw_rx_shiftreg_nval;


// Instances 
bus_control_SM bus_control_SM( 
   .abort                 (abort), 
   .clk                   (clk), 
   .cnt_done              (cnt_done), 
   .end_cnt               (end_cnt), 
   .end_read_elink        (end_read_elink), 
   .end_read_miso         (end_read_miso), 
   .end_write_elink_spi   (end_write_elink_spi), 
   .irq_spi_tra           (irq_spi_tra), 
   .rst                   (rst), 
   .start_bus_init        (power_bus_en), 
   .start_mon_init        (start_mon_init), 
   .start_power_off       (), 
   .start_power_on        (), 
   .start_read_mon        (start_read_mon), 
   .timeoutrst            (main_timeoutrst), 
   .addr                  (addr), 
   .bus_en_done           (power_bus_en_done), 
   .cs_m                  (cs_m), 
   .cs_p                  (cs_p), 
   .end_spi_proc          (end_spi_proc), 
   .entimeout             (entimeout), 
   .mon_en_done           (end_mon_init), 
   .read_spi_mode         (read_spi_mode), 
   .spi_cs                (spi_cs), 
   .start_cnt             (start_cnt), 
   .start_init            (start_init_spi), 
   .start_read_elink      (start_read_elink_spi), 
   .start_read_miso       (start_read_miso), 
   .start_write_elink_spi (start_write_elink_spi), 
   .statedeb              (statedeb)
); 

control_bus #(n_buses) control_bus0( 
   .addr          (addr), 
   .clk           (clk), 
   .cs            (), 
   .cs_p          (cs_p), 
   .miso          (miso_c), 
   .power_bus_en  (power_bus_en), 
   .rst           (rst), 
   .rst_cnt_osc   (rst_osc_cnt), 
   .start_cnt_osc (start_osc_cnt), 
   .cs_active     (cs_active_c), 
   .end_osc_cnt   (end_osc_cnt), 
   .mosi          (mosi_c), 
   .power_bus_cnt (power_bus_cnt), 
   .sck           (sck_c)
); 

elink_core elink_core0( 
   .clk                   (clk), 
   .rst                   (rst), 
   .rx_fifo_full          (rx_fifo_full), 
   .data_rec_uplink       (data_rec_uplink), 
   .start_write_elink     (start_write_link), 
   .tx_efifo_full         (tx_efifo_full), 
   .irq_elink_rec         (irq_elink_rec), 
   .irq_elink_tra         (irq_elink_tra), 
   .end_write_elink       (end_write_elink), 
   .start_read_elink      (start_read_elink), 
   .end_read_elink        (end_read_elink), 
   .data_2bit_in          (data_2bit_in), 
   .data_2bit_out         (data_2bit_out), 
   .fifo_flush            (endwait_all2), 
   .tx_data_rdy           (tx_data_rdy), 
   .rx_data_rdy           (rx_data_rdy), 
   .data_tra_out          (data_tra_downlink), 
   .buffer_tra_en         (buffer_en), 
   .data_tra_spi_out      (data_tra_spi), 
   .irq_spi_tra           (irq_spi_tra), 
   .buffer_spi_tra_en     (buffer_spi_tra_en), 
   .data_rec_spi_in       (data_rec_spi), 
   .end_write_elink_spi   (end_write_elink_spi), 
   .start_write_elink_spi (start_write_elink_spi), 
   .timeoutrst            (main_timeoutrst), 
   .abort                 (abort)
); 

monitor_bus monitor_pp30( 
   .addr              (addr), 
   .buffer_spi_tra_en (buffer_spi_tra_en), 
   .clk               (clk), 
   .cs                (spi_cs), 
   .cs_m              (cs_m), 
   .data_tra_spi      (data_tra_spi), 
   .miso              (miso_m), 
   .rst               (rst), 
   .start_read_miso   (start_read_miso), 
   .cs_active         (cs_active_m), 
   .data_rec_spi      (data_rec_spi), 
   .end_read_miso     (end_read_miso), 
   .mosi              (mosi_m), 
   .sck               (sck_m)
); 

mopshub_core #(n_buses) mopshub_core0( 
   .buffer_en             (buffer_en), 
   .clk                   (clk), 
   .data_tra_downlink     (data_tra_downlink), 
   .end_mon_init          (end_mon_init), 
   .end_osc_cnt           (end_osc_cnt), 
   .end_read_elink        (end_read_elink), 
   .end_write_elink       (end_write_elink), 
   .endwait_all           (endwait_all), 
   .irq_elink_tra         (irq_elink_tra), 
   .osc_auto_trim_mopshub (osc_auto_trim_mopshub), 
   .power_bus_cnt         (power_bus_cnt), 
   .power_bus_en_done     (power_bus_en_done), 
   .rst                   (rst), 
   .rx0                   (rx0), 
   .rx1                   (rx1), 
   .rx10                  (rx10), 
   .rx11                  (rx11), 
   .rx12                  (rx12), 
   .rx13                  (rx13), 
   .rx14                  (rx14), 
   .rx15                  (rx15), 
   .rx16                  (rx16), 
   .rx17                  (rx17), 
   .rx18                  (rx18), 
   .rx19                  (rx19), 
   .rx2                   (rx2), 
   .rx20                  (rx20), 
   .rx21                  (rx21), 
   .rx22                  (rx22), 
   .rx23                  (rx23), 
   .rx24                  (rx24), 
   .rx25                  (rx25), 
   .rx26                  (rx26), 
   .rx27                  (rx27), 
   .rx28                  (rx28), 
   .rx29                  (rx29), 
   .rx3                   (rx3), 
   .rx30                  (rx30), 
   .rx31                  (rx31), 
   .rx4                   (rx4), 
   .rx5                   (rx5), 
   .rx6                   (rx6), 
   .rx7                   (rx7), 
   .rx8                   (rx8), 
   .rx9                   (rx9), 
   .can_rec_select        (can_rec_select), 
   .can_tra_select        (can_tra_select), 
   .data_rec_uplink       (data_rec_uplink), 
   .done_trim_osc_all     (done_trim_osc), 
   .end_init              (end_init), 
   .end_trim_bus          (end_trim_bus), 
   .ext_counter_gen       (ext_counter_gen), 
   .irq_can_rec           (irq_can_rec), 
   .irq_can_tra           (irq_can_tra), 
   .main_timeoutrst       (main_timeoutrst), 
   .power_bus_en          (power_bus_en), 
   .rst_bus               (rst_bus), 
   .rst_osc_cnt           (rst_osc_cnt), 
   .sign_on_sig           (sign_on_sig), 
   .start_init            (start_init), 
   .start_mon_init        (start_mon_init), 
   .start_osc_cnt         (start_osc_cnt), 
   .start_read_elink      (start_read_elink_can), 
   .start_trim_ack        (start_trim_ack), 
   .start_write_elink     (start_write_link), 
   .tx0                   (tx0), 
   .tx1                   (tx1), 
   .tx10                  (tx10), 
   .tx11                  (tx11), 
   .tx12                  (tx12), 
   .tx13                  (tx13), 
   .tx14                  (tx14), 
   .tx15                  (tx15), 
   .tx16                  (tx16), 
   .tx17                  (tx17), 
   .tx18                  (tx18), 
   .tx19                  (tx19), 
   .tx2                   (tx2), 
   .tx20                  (tx20), 
   .tx21                  (tx21), 
   .tx22                  (tx22), 
   .tx23                  (tx23), 
   .tx24                  (tx24), 
   .tx25                  (tx25), 
   .tx26                  (tx26), 
   .tx27                  (tx27), 
   .tx28                  (tx28), 
   .tx29                  (tx29), 
   .tx3                   (tx3), 
   .tx30                  (tx30), 
   .tx31                  (tx31), 
   .tx4                   (tx4), 
   .tx5                   (tx5), 
   .tx6                   (tx6), 
   .tx7                   (tx7), 
   .tx8                   (tx8), 
   .tx9                   (tx9)
); 

// HDL Embedded Text Block 5 tx
assign tx_elink2bit = data_2bit_out;
assign tx_elink1bit = dout1bit_r; 
//-------------------------------------------
//-- serialization of the 2-bit data output:
//-------------------------------------------                                       
always @(posedge clk_80)
    bit_cnt <= ! bit_cnt;
    
always @(posedge clk_80) 
 if (!rst) dout1bit_r <= 1'b1;
 else
   begin
    if(bit_cnt == 0) dout1bit_r <= data_2bit_out[0]; //serialize the first bit
    else             dout1bit_r <= data_2bit_out[1]; //serialize the second bit
   end



















































// HDL Embedded Text Block 8 rx
// Serialization
if (seialize_data_stream == 0)
  begin
    always@(posedge clk)
    if (!rst) data_2bit_in <= 2'b11;
    else      data_2bit_in <= rx_elink2bit;
  end
else 
  begin    
    always@(posedge clk_80)
      if (!rst) data_2bit_in <= 2'b11;
      else      data_2bit_in <= {data_2bit_in[0],rx_elink1bit}; 
  end                                       
 
















































// HDL Embedded Text Block 9 eb7

assign start_read_elink = (start_read_elink_spi || start_read_elink_can);  














































// ModuleWare code(v1.12) for instance 'tx_shift' of 'shiftps'
assign tx_dout = (bit_cnt) ? mw_tx_shiftreg_cval[0] : mw_tx_shiftreg_cval[1];
always @(posedge clk_80)
begin : tx_shiftseq_proc
   if (clk_en)
      mw_tx_shiftreg_cval = mw_tx_shiftreg_nval;
end
assign mw_tx_shiftreg_nval = (~rst) ? 2'd0
   : clk ? data_2bit_out
   : bit_cnt ? {mw_tx_shiftreg_cval[1],mw_tx_shiftreg_cval} >> 1
   : mw_tx_shiftreg_cval << 1;

// ModuleWare code(v1.12) for instance 'rx_shift' of 'shiftsp'
assign data_2bit_inb = mw_rx_shiftreg_cval;
always @(posedge clk_80)
begin : rx_shiftseq_proc
   if (clk_en)
      mw_rx_shiftreg_cval = mw_rx_shiftreg_nval;
end
assign mw_rx_shiftreg_nval = (~rst) ? 2'd0
   : rl ? {rx_din,mw_rx_shiftreg_cval} >> 1
   : {mw_rx_shiftreg_cval,rx_din};

endmodule // mopshub_top

